<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Bloody singleton pattern</title>
    <meta name="viewport" content="width=device-width">

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Bootstrap -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap theme -->
    <link href="/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="/css/theme.css" rel="stylesheet">
    <!-- Custom styles for this blog -->
    <link href="/css/lace.css" rel="stylesheet">

        <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/js/jquery.min.js"></script>

    <script>

/* The good stuff begins here */
$(document).ready(function(){
    $('img').hide().one("load",function(){
        $(this).fadeIn(500);
    }).each(function(){
        if(this.complete) $(this).trigger("load");
    });
});


/*global jQuery */
/*!
* FitText.js 1.2
*
* Copyright 2011, Dave Rupert http://daverupert.com
* Released under the WTFPL license
* http://sam.zoy.org/wtfpl/
*
* Date: Thu May 05 14:23:00 2011 -0600
*/

(function( $ ){

  $.fn.fitText = function( kompressor, options ) {

    // Setup options
    var compressor = kompressor || 1,
        settings = $.extend({
          'minFontSize' : Number.NEGATIVE_INFINITY,
          'maxFontSize' : Number.POSITIVE_INFINITY
        }, options);

    return this.each(function(){

      // Store the object
      var $this = $(this);

      // Resizer() resizes items based on the object width divided by the compressor * 10
      var resizer = function () {
        $this.css('font-size', Math.max(Math.min($this.width() / (compressor*10), parseFloat(settings.maxFontSize)), parseFloat(settings.minFontSize)));
      };

      // Call once to set.
      resizer();

      // Call on resize. Opera debounces their resize by default.
      $(window).on('resize.fittext orientationchange.fittext', resizer);

    });

  };

})( jQuery );

$(document).ready(function(){
  jQuery("#responsive_headline").fitText(1.2, { minFontSize: '20px', maxFontSize: '40px' });
  jQuery("#booger").fitText(0.5, { minFontSize: '20px', maxFontSize: '400px' });
});
</script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->   
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></scrip  t>      
<![endif]-->


  </head>
  <body>
<!-- Fixed navbar -->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand active" href="/">www.BraddahIz.com</a>
    </div>
  </div>
</div>
<div class="container">
  <div class="row">
    <div class="col-sm-3">
      
      <ul class="pager">
        <li class="previous">
          <a href="/testing/2015/01/03/the-state-of-evil.html">
              <span class="glyphicon glyphicon-circle-arrow-left"></span> The state of evil
          </a>
        </li>
      </ul>
      
    </div><!-- col -->
    <div class="col-sm-6">
      <h1 class="text-center">Bloody singleton pattern</h1>
    </div>
    <div class="col-sm-3">
      
    </div><!-- col -->
  </div><!-- row -->
</div> 


<div class="container">
  <div class="row">
   <div class="col-sm-2"></div>
     <div class="col-sm-8">
        <h4>The singleton pattern is an ANTI-pattern.</h4>

<p>I&#39;ve known this for some time and have seen fellow programmers use it as a crutch for years, but I only recently witnessed a great example in the wild.</p>

<p>I was working on integrating an application with a very large corporation&#39;s cloud service (we&#39;ll call them SupaMegaCorp <strong>SMC</strong>).  In doing so I used a gem that SMC provided to deploy and manage virtual machines in the SMC cloud.</p>

<p>This gem used a singleton object to manage configuration data, including login info for a single account.</p>

<p>My application was a type of cross cloud application manager and needed to manage virtual machines in multiple accounts simultaneously.  It couldn&#39;t do that with a single global account configuration.</p>

<p>Sure the application could switch account info on the fly, but that would serialize time expensive cloud operations.  Spinning up servers across different accounts is a task meant to be parallelized.</p>

<p>I ended up monkey patching SMC&#39;s code locally and submitted a patch to the developer maintaining the code.  Below is an example of the SMC problem and my fix for it.
<br><br>
<strong>The SMC api code looked something like this:</strong></p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Configuration</span>
  <span class="kp">include</span> <span class="no">Singleton</span>
  <span class="kp">attr_accessor</span> <span class="ss">:api_username</span><span class="p">,</span> <span class="ss">:api_password</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ApiAccessor</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="n">api_username</span> <span class="o">=</span> <span class="no">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">api_username</span>
    <span class="n">api_password</span> <span class="o">=</span> <span class="no">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">api_password</span>
    <span class="vi">@api_handle</span> <span class="o">=</span> <span class="n">get_handle</span><span class="p">(</span><span class="n">api_username</span><span class="p">,</span> <span class="n">api_password</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create_virtual_machine</span>
    <span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="n">whatever</span> <span class="n">happens</span> <span class="n">where</span> <span class="n">the</span> <span class="vi">@api_handle</span> <span class="n">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">create</span> <span class="n">a</span> <span class="n">virtual</span> <span class="n">machine</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>

<p><br>
<strong>Here is how this api is used.</strong></p>

<div class="highlight"><pre><code class="ruby"><span class="no">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">api_username</span> <span class="o">=</span> <span class="s1">&#39;my_username&#39;</span>
<span class="no">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">api_password</span> <span class="o">=</span> <span class="s1">&#39;my_password&#39;</span>

<span class="n">cloud</span> <span class="o">=</span> <span class="no">ApiAccessor</span><span class="o">.</span><span class="n">new</span>
<span class="n">cloud</span><span class="o">.</span><span class="n">create_virtual_machine</span>
</code></pre></div>

<p><br>
<strong>My fix is below,</strong> it allows for a default global configuration while given the caller freedom to pass in a specific account configuration.</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Configuration</span>
  <span class="vc">@@the_instance</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="kp">attr_accessor</span> <span class="ss">:api_username</span><span class="p">,</span> <span class="ss">:api_password</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instance</span>
    <span class="vc">@@the_instance</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">new</span> <span class="k">unless</span> <span class="vc">@@the_instance</span>
    <span class="k">return</span> <span class="vc">@@the_instance</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">set_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="vc">@@the_instance</span> <span class="o">=</span> <span class="n">instance</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="k">class</span> <span class="nc">ApiAccessor</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">config</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="vi">@config</span> <span class="o">=</span> <span class="n">config</span> <span class="o">||</span> <span class="no">Configuration</span><span class="o">.</span><span class="n">instance</span> 
    <span class="n">api_username</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">api_username</span>
    <span class="n">api_password</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">api_password</span>
    <span class="vi">@api_handle</span> <span class="o">=</span> <span class="n">get_handle</span><span class="p">(</span><span class="n">api_username</span><span class="p">,</span> <span class="n">api_password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>

     </div> <!-- col-sm-8 -->
   <div class="col-sm-2"></div>
  </div>
</div> 


  </body>
</html>
